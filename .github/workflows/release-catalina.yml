# Down&Conv - Build macOS Catalina (branch catalina)
# Parte su push a catalina o workflow_dispatch

name: Release Catalina

on:
  push:
    branches: [catalina]
  workflow_dispatch:

jobs:
  build-macos-catalina:
    runs-on: macos-15-intel
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: catalina

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build .app for Catalina
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          python -m PyInstaller --noconfirm --clean --onedir --windowed --name DownConv \
            --paths=src \
            --collect-all PySide2 \
            --hidden-import=PySide2.QtCore --hidden-import=PySide2.QtGui --hidden-import=PySide2.QtWidgets \
            --hidden-import=yt_dlp \
            --add-data "src/downconv/resources:downconv/resources" \
            src/run_downconv.py

      - name: Fix Info.plist per Catalina (CFBundleShortVersionString deve essere stringa)
        run: |
          /usr/libexec/PlistBuddy -c 'Set :CFBundleShortVersionString "1"' dist/DownConv.app/Contents/Info.plist
          /usr/libexec/PlistBuddy -c 'Set :CFBundleVersion "1"' dist/DownConv.app/Contents/Info.plist

      - name: Zip .app
        run: |
          cd dist && zip -r "../DownConv-catalina-macos.zip" DownConv.app && cd ..

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: catalina
          files: DownConv-catalina-macos.zip
          name: DownConv Catalina (macOS 10.15)
